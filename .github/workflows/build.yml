name: Build and Test
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 25, 26-ea ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test

  push-to-azure:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/us/17033-azure-gh-pipeline'
    env:
      AZURE_ORG: trihydro
      AZURE_PROJECT: SDX
      AZURE_REPO: graphhopper
      JAVA_VERSION: 25
    steps:
      - uses: actions/checkout@v4

      - name: Package JAR
        run: mvn -B package -DskipTests

      - name: Get JAR info and set date
        id: jar-info
        run: |
          JAR_FILE=$(ls web/target/*.jar | head -n 1)
          JAR_NAME=$(basename "$JAR_FILE" | sed 's/-SNAPSHOT//')
          DATE=$(date +%Y%m%d-%H%M%S)

          {
            echo "jar_file=$JAR_FILE"
            echo "jar_name=$JAR_NAME"
            echo "date=$DATE"
          } >> "$GITHUB_OUTPUT"

      - name: Clone Azure DevOps Repository
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
        run: |
          git clone https://$AZURE_DEVOPS_PAT@dev.azure.com/$AZURE_ORG/$AZURE_PROJECT/_git/$AZURE_REPO azure-repo

      - name: Commit and push JAR to new branch
        working-directory: azure-repo
        run: |
          # Set variables
          JAR_FILE="${{ steps.jar-info.outputs.jar_file }}"
          JAR_NAME="${{ steps.jar-info.outputs.jar_name }}"
          BUILD_DATE="${{ steps.jar-info.outputs.date }}"
          COMMIT_SHA="${{ github.sha }}"
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions@users.noreply.github.com"

          # Create a new branch
          BRANCH_NAME="update-graphhopper-jar-$BUILD_DATE"
          git checkout -b $BRANCH_NAME

          # Create resources directory if it doesn't exist
          mkdir -p resources

          # Rename existing JAR file if it exists
          if [ -f "resources/$JAR_NAME" ]; then
            OLD_NAME="resources/$(basename $JAR_NAME .jar)-old-$BUILD_DATE.jar"
            mv "resources/$JAR_NAME" "$OLD_NAME"
          fi

          # Copy new JAR file
          cp ../$JAR_FILE resources/$JAR_NAME

          # Commit changes
          git add resources/
          git commit -m "Update GraphHopper JAR from GitHub build - $BUILD_DATE" \
                     -m "Built from commit: $COMMIT_SHA" \
                     -m "Java version: $JAVA_VERSION"

          # Push the branch
          git push origin $BRANCH_NAME

          # Save branch name for PR creation
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request in Azure DevOps
        env:
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          AZURE_GH_REPO_ID: ${{ secrets.AZURE_GH_REPO_ID }}
          REVIEWER_ID_TEAGHEN: ${{ secrets.TEAGHEN_DEVOPS_USER_ID }}
          REVIEWER_ID_CHAN: ${{ secrets.CHAN_DEVOPS_USER_ID }}
        run: |
          # Set variables
          BUILD_DATE="${{ steps.jar-info.outputs.date }}"
          COMMIT_SHA="${{ github.sha }}"
          AUTH_HEADER=$(echo -n ":${AZURE_DEVOPS_PAT}" | base64 | tr -d '\n')

          PR_PAYLOAD=$(cat <<EOF
          {
            "sourceRefName": "refs/heads/${{ env.BRANCH_NAME }}",
            "targetRefName": "refs/heads/master",
            "title": "Update GraphHopper JAR - $BUILD_DATE",
            "description": "Automated PR to update GraphHopper JAR file.\n\n**Source:** GitHub repository\n**Commit:** $COMMIT_SHA\n**Java Version:** $JAVA_VERSION\n**Build Date:** $BUILD_DATE\n\nThis JAR was automatically built and uploaded by GitHub Actions.",
            "reviewers": [
              {
                "id": "${REVIEWER_ID_TEAGHEN}"
              },
              {
                "id": "${REVIEWER_ID_CHAN}"
              }
            ]
          }
          EOF
          )

          # Make API request
          HTTP_CODE=$(curl -sSL -w "%{http_code}" -o /tmp/pr_response.json \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $AUTH_HEADER" \
            -d "$PR_PAYLOAD" \
            "https://dev.azure.com/${AZURE_ORG}/${AZURE_PROJECT}/_apis/git/repositories/${AZURE_GH_REPO_ID}/pullrequests?api-version=7.1")

          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "Failed to create Pull Request (HTTP $HTTP_CODE)"
            cat /tmp/pr_response.json
            exit 1
          fi
